<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Food Express - Cart & Checkout</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { font-family:'Inter',sans-serif; background:#f9f9f9; }
.toast-hidden{opacity:0; transform:translateY(24px); pointer-events:none;}
.toast-show{opacity:1; transform:translateY(0); transition: all 320ms cubic-bezier(.2,.9,.3,1); pointer-events:auto;}
.animate-bump{transform:scale(1.08); transition:transform 0.18s;}
.quantity-box{min-width:30px; text-align:center; font-weight:bold;}
.popup-overlay{position:fixed; inset:0; background: rgba(0,0,0,0.32); backdrop-filter: blur(6px); display:flex; align-items:center; justify-content:center; z-index:60; opacity:0; pointer-events:none; transition: all .28s;}
.popup-overlay.active{opacity:1; pointer-events:auto;}
.popup{transform:translateY(36px); opacity:0; transition: all .28s ease; max-width:95vw; background:white; border-radius:1rem; padding:2rem;}
.popup-overlay.active .popup{transform:translateY(0); opacity:1;}
.checkmark{width:60px; height:60px; border-radius:50%; display:inline-block; stroke-width:2; stroke:#fff; stroke-miterlimit:10; box-shadow: inset 0px 0px 0px #fff; animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;}
.checkmark__circle{stroke-dasharray:166; stroke-dashoffset:166; stroke-width:2; stroke-miterlimit:10; stroke:#FF6B00; fill:none; animation: stroke .6s cubic-bezier(.65,0,.45,1) forwards;}
.checkmark__check{transform-origin:50% 50%; stroke-dasharray:48; stroke-dashoffset:48; animation: stroke .3s cubic-bezier(.65,0,.45,1) .8s forwards;}
@keyframes stroke{100%{stroke-dashoffset:0;}}
@keyframes scale{0%,100%{transform:none;}50%{transform:scale3d(1.1,1.1,1);}}
@keyframes fill{100%{box-shadow:inset 0 0 0 30px #FF6B00;}}
.payment-btn.selected{border-color:#FF6B00; background:#FFF4E6; box-shadow:0 4px 12px rgba(255,107,0,0.2);}
@media (max-width:640px){ .cart-item { flex-direction: column; align-items: flex-start; } .cart-item img { width:100%; height:auto; margin-bottom:0.5rem; } #paymentGrid { flex-direction: column; } .flex-wrap { flex-wrap: wrap; } }


/* Overlay fade + blur animation */
.popup-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.32);
  backdrop-filter: blur(6px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 60;
  opacity: 0;
  pointer-events: none;
  transform: translateY(100%);
  transition: opacity 0.35s ease, transform 0.35s ease;
}

/* Slide-up and fade-in popup */
.popup-overlay.active {
  opacity: 1;
  pointer-events: auto;
  transform: translateY(0);
}

/* Smooth slide-down when closing */
.popup-overlay.closing {
  opacity: 0;
  transform: translateY(100%);
}

/* Popup box */
.popup {
  background: white;
  border-radius: 1rem;
  padding: 2rem;
  width: 100%;
  max-width: 400px;
  transform: translateY(36px);
  opacity: 0;
  transition: all 0.35s ease;
}

.popup-overlay.active .popup {
  transform: translateY(0);
  opacity: 1;
}

.popup-overlay.closing .popup {
  transform: translateY(36px);
  opacity: 0;
}

/* Allow touch interactions for swipe gesture */
.popup {
  touch-action: none;
}

/* Bottom sheet style */
.popup-overlay {
  align-items: flex-end; /* start from bottom */
  justify-content: center;
}

.bottom-sheet {
  border-radius: 1.5rem 1.5rem 0 0;
  width: 100%;
  max-width: 500px;
  margin: 0 auto;
  transform: translateY(100%);
  transition: transform 0.3s ease, opacity 0.3s ease;
}

.popup-overlay.active .bottom-sheet {
  transform: translateY(0);
  opacity: 1;
}
@keyframes pulseGlow {
  0%, 100% {
    box-shadow: 0 0 0 0 rgba(251, 146, 60, 0.4);
    transform: scale(1);
  }
  50% {
    box-shadow: 0 0 0 8px rgba(251, 146, 60, 0);
    transform: scale(1.03);
  }
}

.pulse-glow {
  animation: pulseGlow 1.2s ease-in-out infinite;
}
@keyframes pulseGlow {
  0%, 100% { box-shadow: 0 0 0 0 rgba(251, 146, 60, 0.4); }
  50% { box-shadow: 0 0 15px 3px rgba(251, 146, 60, 0.3); }
}

.pulse-glow {
  animation: pulseGlow 1.4s infinite;
}

#addressPopup { z-index: 70; }

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  20%, 60% { transform: translateX(-6px); }
  40%, 80% { transform: translateX(6px); }
}
.animate-shake {
  animation: shake 0.4s ease;
}




</style>
</head>
<body class="text-gray-800">

<header class="bg-white shadow-md sticky top-0 z-40">
  <div class="max-w-5xl mx-auto px-5 py-4 flex items-center justify-between">
    <div class="text-2xl font-extrabold text-orange-500">üçΩÔ∏è Food Express</div>
    <button id="backBtn" class="text-orange-500 font-semibold">‚Üê Back</button>
  </div>
</header>

<main class="max-w-5xl mx-auto px-4 py-6 space-y-6">
<section id="cartSection">
  <h1 class="text-3xl font-bold mb-3">Your Cart</h1>
  <div id="cartContainer" class="space-y-4"></div>
  <div class="mt-6 bg-white p-5 rounded-2xl shadow flex justify-between items-center">
    <span class="text-lg font-semibold">Total:</span>
    <span id="cartTotal" class="text-2xl font-bold text-orange-600">‚Çπ0</span>
  </div>
  <button id="addAddressBtn" class="mt-4 w-full bg-gradient-to-r from-orange-500 to-orange-600 text-white py-3 rounded-full font-bold shadow-lg hover:from-orange-600 hover:to-orange-700 transition-all duration-200">
    Add Delivery Address
  </button>
</section>

<!-- üè† Address Popup -->
<div id="addressPopup" class="popup-overlay">
  <div class="popup">
    <h3 class="text-xl font-semibold mb-3 text-orange-600 text-center">üè† Add Delivery Address</h3>

    <input id="addrName" type="text" placeholder="Full name" class="w-full px-3 py-2 border rounded-lg mb-2" required />
<input id="addrPhone" 
  type="tel" 
  placeholder="Phone number" 
  class="w-full px-3 py-2 border rounded-lg mb-2 focus:ring-2 focus:ring-orange-500" 
  required 
  pattern="[0-9]{10}" 
  inputmode="numeric"
/>
<small id="phoneError" class="text-red-500 text-sm hidden">Enter a valid 10-digit number</small>
    <input id="addrStreet" type="text" placeholder="House / Street / Locality" class="w-full px-3 py-2 border rounded-lg mb-2" required />

    <div class="grid grid-cols-2 gap-2 mb-3">
      <input id="addrCity" type="text" placeholder="City" class="px-3 py-2 border rounded-lg" required />
      <input id="addrPincode" type="text" placeholder="Pincode" class="px-3 py-2 border rounded-lg" required />
    </div>


    <!-- üìç Use Current Location Button -->
    <button id="useCurrentLocationBtn"
      class="w-full flex items-center justify-center gap-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-semibold py-3 rounded-full shadow-lg hover:from-blue-600 hover:to-blue-700 active:scale-[0.98] transition-all duration-200 mb-4">
      <svg id="locSpinner" class="hidden animate-spin w-5 h-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none"
        viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor"
          d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
      </svg>
      <img id="locIcon" src="https://cdn-icons-png.flaticon.com/512/684/684908.png" class="w-5 h-5" alt="location icon" />
      <span id="locText">Use Current Location</span>
    </button>

    <div class="flex gap-2">
      <button id="saveAddressBtn" class="flex-1 bg-orange-500 text-white py-2 rounded-lg font-semibold">
        Save Address
      </button>
      <button id="cancelAddressBtn" class="flex-1 bg-gray-100 text-gray-700 py-2 rounded-lg">
        Cancel
      </button>
    </div>
  </div>
</div>
<!-- üè† Saved Delivery Address (Zomato-style card) -->
<div id="savedAddressPreview" class="hidden mt-4 bg-white border border-gray-100 shadow-sm rounded-xl p-4 flex justify-between items-start">
  <div>
    <p class="font-semibold text-gray-900 text-base flex items-center gap-2">
      <span>üìç</span> <span id="previewName">Delivery Address</span>
    </p>
    <p id="previewStreet" class="text-gray-700 text-sm mt-1"></p>
    <p id="previewCity" class="text-gray-600 text-sm"></p>
    <p id="previewPincode" class="text-gray-600 text-sm"></p>
    <p id="previewPhone" class="text-gray-700 text-sm mt-1 flex items-center gap-1">
      üìû <span id="previewPhoneText"></span>
    </p>
  </div>
  <button id="editAddressBtn" class="text-orange-500 font-medium text-sm hover:text-orange-600 transition">
    Change
  </button>
</div>






<section id="paymentSection" class="bg-white p-5 rounded-2xl shadow-md hidden">
  <h2 class="text-xl font-semibold mb-3">Select Payment Method</h2>
  <div id="paymentGrid" class="flex gap-4 flex-col sm:flex-row">
    <button class="payment-btn flex items-center gap-3 p-3 border rounded-xl shadow-sm hover:shadow-md transition-all" id="gpayBtn">
      <img src="https://i.postimg.cc/7Z8gybDt/google-pay-6124998.png" class="w-10 h-10 object-contain" alt="GPay"/>
      <div><div class="font-medium">GPay (UPI)</div><div class="text-xs text-gray-500">Open app to pay</div></div>
    </button>
    <button class="payment-btn flex items-center gap-3 p-3 border rounded-xl shadow-sm hover:shadow-md transition-all" id="phonepeBtn">
      <img src="https://img.icons8.com/color/48/phone-pe.png" class="w-10 h-10 object-contain" alt="PhonePe"/>
      <div><div class="font-medium">PhonePe (UPI)</div><div class="text-xs text-gray-500">Open app to pay</div></div>
    </button>
  </div>
  <button id="payBtn" class="mt-4 w-full bg-gradient-to-r from-orange-500 to-orange-600 text-white py-3 rounded-full font-bold shadow-lg hover:from-orange-600 hover:to-orange-700 transition-all duration-200">
    <span id="payBtnText">Pay & Place Order</span>
  </button>
</section>
</main>

<div id="toast" class="fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-orange-500 text-white px-6 py-3 rounded-full shadow-lg toast-hidden z-50" role="status" aria-live="polite"></div>

<div id="successPopup" class="popup-overlay">
  <div class="popup text-center">
    <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
      <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
      <path class="checkmark__check" fill="none" d="M14 27l7 7 16-16"/>
    </svg>
    <h3 class="mt-3 text-xl font-semibold text-green-600">Order Placed Successfully!</h3>
    <p class="mt-2 text-gray-600">Your order ID is <span id="orderId"></span></p>
    <button id="continueShoppingBtn" class="mt-4 bg-orange-500 text-white py-2 px-4 rounded-lg font-semibold">Continue Shopping</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCAGirQsFfQNInhUc9yuMD-QElaDnmRbKE",
  authDomain: "foodexpress-9b0ff.firebaseapp.com",
  projectId: "foodexpress-9b0ff",
  storageBucket: "foodexpress-9b0ff.firebasestorage.app",
  messagingSenderId: "818281594225",
  appId: "1:818281594225:web:205774c2914ae2b9b08ad0"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const LOCAL_CART_KEY="fe_cart_v1";
let cart=JSON.parse(localStorage.getItem(LOCAL_CART_KEY)||"[]");
const toast=document.getElementById("toast");

function showToast(msg){ toast.innerText=msg; toast.classList.remove("toast-hidden"); toast.classList.add("toast-show"); setTimeout(()=>{ toast.classList.remove("toast-show"); toast.classList.add("toast-hidden"); },1500); }
function persistCart(){ localStorage.setItem(LOCAL_CART_KEY,JSON.stringify(cart)); updateCartUI(); saveUserCart(); }
async function saveUserCart(){ try{ const user=auth.currentUser; if(!user) return; const userRef=doc(db,"users",user.uid); await setDoc(userRef,{cart},{merge:true}); }catch(err){console.error(err);} }

function updateCartUI(){
    const container=document.getElementById("cartContainer"); container.innerHTML=""; let total=0;
    if(cart.length===0){ container.innerHTML='<p class="text-gray-500">Your cart is empty.</p>'; document.getElementById("cartTotal").innerText="‚Çπ0"; return; }
    cart.forEach((item,index)=>{ 
        const itemTotal=item.price*(item.quantity||1); total+=itemTotal;
        const div=document.createElement("div");
        div.className="cart-item bg-white rounded-xl p-3 flex items-center gap-4 shadow flex-wrap";
        div.innerHTML=`<img src="${item.image}" class="w-20 h-20 object-cover rounded-lg"/>
        <div class="flex-1">
        <div class="font-semibold">${item.name}</div>
        <div class="text-gray-500">‚Çπ${item.price} √ó <span class="quantity-box" id="qty-${index}">${item.quantity}</span> = ‚Çπ<span id="item-total-${index}">${itemTotal}</span></div>
        <div class="mt-2 flex gap-2 flex-wrap">
        <button class="decrease bg-gray-100 px-3 rounded-full">-</button>
        <button class="increase bg-gray-100 px-3 rounded-full">+</button>
        <button class="remove bg-red-500 text-white px-3 rounded-full">Remove</button>
        </div></div>`;
        container.appendChild(div);
        div.querySelector(".decrease").addEventListener("click",()=>changeQuantity(index,-1));
        div.querySelector(".increase").addEventListener("click",()=>changeQuantity(index,1));
        div.querySelector(".remove").addEventListener("click",()=>removeItem(index));
    });
    const cartTotalEl=document.getElementById("cartTotal"); cartTotalEl.innerText="‚Çπ"+total; cartTotalEl.classList.remove("animate-bump"); void cartTotalEl.offsetWidth; cartTotalEl.classList.add("animate-bump");
}
function changeQuantity(index,delta){ cart[index].quantity=(cart[index].quantity||1)+delta; if(cart[index].quantity<=0) cart.splice(index,1); persistCart(); showToast("Cart updated ‚úÖ"); }
function removeItem(index){ cart.splice(index,1); persistCart(); showToast("Item removed ‚ùå"); }



document.getElementById("addAddressBtn").addEventListener("click", () => {
  addressPopup.classList.add("active");

  // üß† Auto-fill previously saved address (if exists)
  const saved = JSON.parse(localStorage.getItem("fe_address") || "{}");
  document.getElementById("addrName").value = saved.name || "";
  document.getElementById("addrPhone").value = saved.phone || "";
  document.getElementById("addrStreet").value = saved.street || "";
  document.getElementById("addrCity").value = saved.city || "";
  document.getElementById("addrPincode").value = saved.pincode || "";

  setTimeout(() => document.getElementById("addrPhone").focus(), 400);
});


document.getElementById("cancelAddressBtn").addEventListener("click", () => {
  addressPopup.classList.add("closing");
  setTimeout(() => {
    addressPopup.classList.remove("active", "closing");
  }, 350);
});




// ======= üìç DETECT LOCATION (Auto-fill street, city, pincode) =======
const detectLocationBtn = document.getElementById("detectLocationBtn");

if (detectLocationBtn) {
  detectLocationBtn.addEventListener("click", () => {
    showToast("üìç Detecting your location...");

    if (!navigator.geolocation) {
      showToast("‚ùå Geolocation not supported");
      return;
    }

    navigator.geolocation.getCurrentPosition(
      async (position) => {
        const { latitude, longitude } = position.coords;

        try {
          const res = await fetch(
            `https://nominatim.openstreetmap.org/reverse?lat=${latitude}&lon=${longitude}&format=json`
          );
          const data = await res.json();

          // Extract details
          const address = data.address || {};
          const street =
            address.road ||
            address.neighbourhood ||
            address.suburb ||
            address.village ||
            "";
          const city =
            address.city ||
            address.town ||
            address.state_district ||
            address.county ||
            "";
          const pincode = address.postcode || "";

          // Fill the fields
          document.getElementById("addrStreet").value = street;
          document.getElementById("addrCity").value = city;
          document.getElementById("addrPincode").value = pincode;

          showToast("‚úÖ Location detected successfully!");
        } catch (err) {
          console.error(err);
          showToast("‚ö†Ô∏è Failed to detect location");
        }
      },
      (error) => {
        console.error(error);
        showToast("‚ö†Ô∏è Please allow location access");
      }
    );
  });
}

// ======= üìû PHONE NUMBER VALIDATION + SAVE ADDRESS =======
const phoneInput = document.getElementById("addrPhone");

phoneInput.addEventListener("input", () => {
  // Allow only digits, max 10
  phoneInput.value = phoneInput.value.replace(/\D/g, "").slice(0, 10);
});

// ‚úÖ Separate address preview function
function updateAddressPreview() {
  let saved = localStorage.getItem("fe_address");
  try {
    saved = JSON.parse(saved);
  } catch {
    saved = null;
  }

  const previewBox = document.getElementById("savedAddressPreview");
  if (saved && saved.name && saved.phone) {
    document.getElementById("previewName").textContent = saved.name;
    document.getElementById("previewPhone").textContent = `üìû ${saved.phone}`;
    document.getElementById("previewStreet").textContent = saved.street || "";
    document.getElementById("previewCity").textContent = saved.city || "";
    document.getElementById("previewPincode").textContent = saved.pincode || "";
    previewBox.classList.remove("hidden");
  } else {
    previewBox.classList.add("hidden");
  }
}
window.addEventListener("DOMContentLoaded", updateAddressPreview);

document.getElementById("saveAddressBtn").addEventListener("click", () => {
  const nameEl = document.getElementById("addrName");
  const phoneEl = document.getElementById("addrPhone");
  const streetEl = document.getElementById("addrStreet");
  const cityEl = document.getElementById("addrCity");
  const pincodeEl = document.getElementById("addrPincode");
  const phoneError = document.getElementById("phoneError");

  // Reset errors
  phoneError.classList.add("hidden");
  [nameEl, phoneEl, streetEl, cityEl, pincodeEl].forEach(input =>
    input.classList.remove("border-red-500")
  );

  // Check for empty fields
  let missingFields = [];
  if (!nameEl.value.trim()) missingFields.push("Full Name");
  if (!phoneEl.value.trim()) missingFields.push("Phone Number");
  if (!streetEl.value.trim()) missingFields.push("Street");
  if (!cityEl.value.trim()) missingFields.push("City");
  if (!pincodeEl.value.trim()) missingFields.push("Pincode");

  if (missingFields.length > 0) {
    showToast(`‚ö†Ô∏è Please fill: ${missingFields.join(", ")}`);
    return;
  }

  // Validate phone number
  if (!/^[0-9]{10}$/.test(phoneEl.value.trim())) {
    phoneError.classList.remove("hidden");
    phoneEl.classList.add("border-red-500", "animate-shake");
    showToast("üìû Enter a valid 10-digit phone number");
    setTimeout(() => phoneEl.classList.remove("animate-shake"), 500);
    return;
  }

  // ‚úÖ Save address correctly (values only)
  const address = {
    name: nameEl.value.trim(),
    phone: phoneEl.value.trim(),
    street: streetEl.value.trim(),
    city: cityEl.value.trim(),
    pincode: pincodeEl.value.trim(),
  };

localStorage.setItem("fe_address", JSON.stringify(address));

showToast("‚úÖ Address saved successfully!");
function updateAddressPreview() {
  const saved = JSON.parse(localStorage.getItem("fe_address") || "{}");
  const previewBox = document.getElementById("savedAddressPreview");

  if (saved.name) {
    document.getElementById("previewName").textContent = saved.name || "Delivery Address";
    document.getElementById("previewStreet").textContent = saved.street || "";
    document.getElementById("previewCity").textContent = saved.city || "";
    document.getElementById("previewPincode").textContent = saved.pincode || "";
    document.getElementById("previewPhoneText").textContent = saved.phone || "";

    previewBox.classList.remove("hidden");
    document.getElementById("addAddressBtn").innerText = "Edit Delivery Address";
  } else {
    previewBox.classList.add("hidden");
    document.getElementById("addAddressBtn").innerText = "Add Delivery Address";
  }
}




  // Show payment section
  document.getElementById("paymentSection").classList.remove("hidden");

  // Smooth close of popup
  addressPopup.classList.add("closing");
  setTimeout(() => {
    addressPopup.classList.remove("active", "closing");
    // Clear inputs
    nameEl.value = "";
    phoneEl.value = "";
    streetEl.value = "";
    cityEl.value = "";
    pincodeEl.value = "";
  }, 380);

  

  // Scroll to payment
  setTimeout(() => {
    document
      .getElementById("paymentSection")
      .scrollIntoView({ behavior: "smooth" });
  }, 500);
});






// üß≠ Detect and Fill Current Location
const locBtn = document.getElementById("useCurrentLocationBtn");
const locText = document.getElementById("locText");
const locIcon = document.getElementById("locIcon");
const locSpinner = document.getElementById("locSpinner");

locBtn.addEventListener("click", () => {
  if (!navigator.geolocation) {
    showToast("‚ùå Geolocation not supported");
    return;
  }

  // Start loading animation
  locBtn.disabled = true;
  locText.textContent = "Detecting location...";
  locIcon.classList.add("hidden");
  locSpinner.classList.remove("hidden");

  navigator.geolocation.getCurrentPosition(async (pos) => {
    const { latitude, longitude } = pos.coords;
    try {
      const res = await fetch(
        `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`
      );
      const data = await res.json();
      const address = data.address || {};

   // üè† Combine parts for a detailed street/locality field
      const streetParts = [
        address.house_number,
        address.road,
        address.neighbourhood,
        address.suburb,
        address.state_district
      ].filter(Boolean);

      const streetFull = streetParts.join(", ");

      // Fill form fields automatically
      document.getElementById("addrStreet").value =
        `${address.house_number || ""} ${address.road || ""} ${address.suburb || ""}`.trim();
      document.getElementById("addrCity").value =
        address.city || address.town || address.village || "";
      document.getElementById("addrPincode").value = address.postcode || "";
      document.getElementById("addrName").value =
        address.neighbourhood || "My Home";

          // Save address to localStorage
showToast("üìç Location detected! Address filled automatically");
locText.textContent = "Location Detected!";
locBtn.classList.replace("from-blue-500", "from-green-500");
locBtn.classList.replace("to-blue-600", "to-green-600");
locBtn.classList.add("pulse-glow");
locBtn.disabled = false;
locSpinner.classList.add("hidden");
locIcon.classList.remove("hidden");


      // ‚úÖ UI feedback
      showToast("üìç Location detected! Address filled automatically");
      locText.textContent = "Location Detected!";
      locBtn.classList.replace("from-blue-500", "from-green-500");
      locBtn.classList.replace("to-blue-600", "to-green-600");
      locBtn.classList.add("pulse-glow");

    // Re-enable button
      locBtn.disabled = false;
      locSpinner.classList.add("hidden");
      locIcon.classList.remove("hidden")

    } catch (error) {
      console.error(error);
      showToast("‚ùå Unable to fetch address");
      locText.textContent = "Try Again";
    } finally {
      locBtn.disabled = false;
      locSpinner.classList.add("hidden");
      locIcon.classList.remove("hidden");
    }
  }, () => {
    showToast("‚ö†Ô∏è Location access denied");
    locText.textContent = "Use Current Location";
    locBtn.disabled = false;
    locSpinner.classList.add("hidden");
    locIcon.classList.remove("hidden");
  });
});




document.getElementById("backBtn").addEventListener("click",()=>{ history.back(); });

const paymentButtons=document.querySelectorAll(".payment-btn");
let selectedPayment=null;
paymentButtons.forEach(btn=>{ btn.addEventListener("click",()=>{
  paymentButtons.forEach(b=>b.classList.remove("selected"));
  btn.classList.add("selected");
  selectedPayment=btn.id;
}); });

function showOrderSuccess(orderId){ document.getElementById("orderId").innerText=orderId; document.getElementById("successPopup").classList.add("active"); cart=[]; persistCart(); }

async function saveOrderToFirebase(orderId, txnId, status){
    try {
        const user = auth.currentUser;
        if(!user) return;
        const address = JSON.parse(localStorage.getItem("fe_address")||"{}");
        await setDoc(doc(db, "orders", orderId), {
            userId: user.uid,
            items: cart,
            total: cart.reduce((sum,i)=>sum+i.price*i.quantity,0),
            address: address,
            paymentMethod: selectedPayment==="gpayBtn"?"GPay":"PhonePe",
            status: status,
            txnId: txnId,
            createdAt: new Date()
        });
    } catch(e){ console.error(e); }
}

document.getElementById("payBtn").addEventListener("click",()=>{
    if(!cart.length){ showToast("Cart is empty"); return; }
    if(!selectedPayment){ showToast("Select a payment method"); return; }

    const total = cart.reduce((sum,i)=>sum+i.price*i.quantity,0);
    const orderId = "ORD"+Date.now();
    const callbackUrl = encodeURIComponent(window.location.origin + `/checkout.html?orderId=${orderId}`);

    let upiUrl = "";
    if(selectedPayment==="gpayBtn")
        upiUrl = `upi://pay?pa=8438618540@ybl&pn=FoodExpress&am=${total}&cu=INR&url=${callbackUrl}`;
    if(selectedPayment==="phonepeBtn")
        upiUrl = `phonepe://pay?pa=8438618540@ybl&pn=FoodExpress&am=${total}&cu=INR&url=${callbackUrl}`;

    window.location.href = upiUrl;
});

// UPI callback simulation
const params = new URLSearchParams(window.location.search);
if(params.get("orderId")){
    const orderId = params.get("orderId");
    const txnId = params.get("txnId") || "UPI_TXN_"+Date.now();
    const status = params.get("status") || "success"; // In real app, webhook confirms

    if(status==="success"){
        saveOrderToFirebase(orderId, txnId, status).then(()=> showOrderSuccess(orderId));
    } else {
        showToast("Payment failed ‚ùå");
    }
}

document.getElementById("continueShoppingBtn").addEventListener("click",()=>{ document.getElementById("successPopup").classList.remove("active"); window.location.href="index.html"; });

onAuthStateChanged(auth,user=>{if(user) saveUserCart();});
updateCartUI();

// ‚ÄúChange‚Äù button inside saved address card
document.body.addEventListener("click", (e) => {
  if (e.target.id === "editAddressBtn") {
    document.getElementById("addAddressBtn").click(); // reopen popup
  }
});

</script>
</body>
</html>
