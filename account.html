<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Account - Food Express</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .eye-icon {
      width: 1.5rem;
      height: 1.5rem;
      position: absolute;
      right: 0.5rem;
      top: 0.5rem;
      color: gray;
      cursor: pointer;
      user-select: none;
    }
    .crossed-eye { opacity: 0.95; transform: rotate(0deg); }
    .crossed-eye path.cross-line { display: inline; }
    .eye-icon path.cross-line { display: none; }
  </style>
</head>
<body class="bg-white font-sans">

  <!-- Main Account Section -->
  <div class="flex flex-col items-center justify-start min-h-screen pb-20 pt-10">
    <div id="profileSection" class="hidden text-center mb-6">
      <img id="profilePic" src="" class="w-24 h-24 rounded-full mb-3 shadow" />
      <h2 id="profileName" class="text-xl font-bold"></h2>
      <button onclick="logout()" class="mt-4 bg-red-500 text-white px-4 py-2 rounded">Logout</button>
    </div>

    <div id="guestSection" class="hidden text-center">
      <p class="mb-4 text-gray-600">You are not logged in</p>
      <button onclick="openAccountPanel('signup')" class="bg-orange-500 text-white px-4 py-2 rounded">Login / Sign Up</button>
    </div>

    <!-- Extra Account Options -->
    <div id="accountOptions" class="hidden w-full max-w-md mx-auto mt-6">
      <div class="bg-white rounded-lg shadow divide-y">
        <a href="orders.html" class="flex items-center p-4 hover:bg-gray-50">üì¶ <span class="ml-3">My Orders</span></a>
        <a href="favorites.html" class="flex items-center p-4 hover:bg-gray-50">‚ù§Ô∏è <span class="ml-3">Favorites</span></a>
        <a href="payments.html" class="flex items-center p-4 hover:bg-gray-50">üí≥ <span class="ml-3">Payment Methods</span></a>
        <a href="addresses.html" class="flex items-center p-4 hover:bg-gray-50">üìç <span class="ml-3">Manage Addresses</span></a>
        <a href="support.html" class="flex items-center p-4 hover:bg-gray-50">üõ† <span class="ml-3">Help & Support</span></a>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <div class="fixed bottom-0 left-0 right-0 bg-white shadow-t p-2 flex justify-around items-center border-t">
    <a href="index.html" class="text-center">üè†<br><span class="text-xs">Home</span></a>
    <a href="orders.html" class="text-center">üì¶<br><span class="text-xs">Orders</span></a>
    <a href="cart.html" class="text-center">üõí<br><span class="text-xs">Cart</span></a>
    <a href="account.html" class="text-center text-orange-500">üë§<br><span class="text-xs">Account</span></a>
  </div>

  <!-- Slide-Up Account Panel -->
  <div id="accountPanel" class="fixed bottom-[-100%] left-0 w-full bg-white rounded-t-2xl shadow-lg p-6 transition-all duration-300 z-50">
    <div id="accountContent"></div>
    <button onclick="closeAccountPanel()" class="mt-4 w-full py-2 bg-gray-200 rounded-lg">Close</button>
  </div>

  <script>
    const DEFAULT_AVATAR = "https://i.postimg.cc/SK7cPYdB/cartoon-avatar.png";
    let currentUser = localStorage.getItem("loggedInUser");
    let passwordTimers = {};

    function renderAccountPage() {
      const users = JSON.parse(localStorage.getItem("users") || "[]");
      const user = users.find(u => u.email === currentUser);

      if (user) {
        document.getElementById("profileSection").style.display = "block";
        document.getElementById("guestSection").style.display = "none";
        document.getElementById("accountOptions").style.display = "block";
        document.getElementById("profileName").innerText = user.name;
        document.getElementById("profilePic").src = user.avatar || DEFAULT_AVATAR;
        normalizeUserRecord(user.email);
      } else {
        document.getElementById("guestSection").style.display = "block";
        document.getElementById("profileSection").style.display = "none";
        document.getElementById("accountOptions").style.display = "none";
      }
    }

    function openAccountPanel(mode) {
      const content = document.getElementById("accountContent");
      content.innerHTML = mode === "signup" ? getSignupForm() : getLoginForm();
      document.getElementById("accountPanel").style.bottom = "0";
    }

    function closeAccountPanel() {
      document.getElementById("accountPanel").style.bottom = "-100%";
    }

    function getSignupForm() {
      return `
        <h2 class="text-lg font-bold mb-4">Sign Up</h2>
        <input type="text" id="nameField" placeholder="Name" class="border p-2 w-full mb-2 rounded" oninput="clearSignupMessage()" />
        <input type="email" id="emailField" placeholder="Email" class="border p-2 w-full mb-2 rounded" oninput="clearSignupMessage()" />
        <div class="relative mb-2">
          <input type="password" id="passwordField" placeholder="Password (min 6 chars)" class="border p-2 w-full rounded" oninput="clearSignupMessage()" />
          ${eyeIconHTML("passwordField")}
        </div>
        <div class="relative mb-4">
          <input type="password" id="confirmPasswordField" placeholder="Confirm Password" class="border p-2 w-full rounded" oninput="clearSignupMessage()" />
          ${eyeIconHTML("confirmPasswordField")}
        </div>

        <div id="signupMessage" class="min-h-[1.25rem] mb-4 text-sm"></div>

        <button onclick="submitSignup()" class="bg-orange-500 text-white py-2 px-4 w-full rounded">Sign Up</button>
        <p class="mt-4 text-sm text-center">Already have an account? <a href="#" onclick="openAccountPanel('login')" class="text-orange-500">Login</a></p>
      `;
    }

    function getLoginForm() {
      return `
        <h2 class="text-lg font-bold mb-4">Login</h2>
        <input type="email" id="loginEmailField" placeholder="Email" class="border p-2 w-full mb-2 rounded" oninput="clearLoginMessage()" />
        <div class="relative mb-4">
          <input type="password" id="loginPasswordField" placeholder="Password" class="border p-2 w-full rounded" oninput="clearLoginMessage()" />
          ${eyeIconHTML("loginPasswordField")}
        </div>

        <div id="loginMessage" class="min-h-[1.25rem] mb-4 text-sm"></div>

        <button onclick="submitLogin()" class="bg-orange-500 text-white py-2 px-4 w-full rounded">Login</button>
        <p class="mt-4 text-sm text-center">Don't have an account? <a href="#" onclick="openAccountPanel('signup')" class="text-orange-500">Sign Up</a></p>
      `;
    }

    function eyeIconHTML(fieldId) {
      return `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
          class="eye-icon"
          onmousedown="startShowPassword('${fieldId}', this)"
          onmouseup="hidePassword('${fieldId}', this)"
          onmouseleave="hidePassword('${fieldId}', this)"
          ontouchstart="startShowPassword('${fieldId}', this)"
          ontouchend="hidePassword('${fieldId}', this)"
          onclick="togglePassword('${fieldId}', this)">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 
            4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
          <path class="cross-line" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3l18 18" />
        </svg>
      `;
    }

    function startShowPassword(id, icon) {
      clearTimeout(passwordTimers[id]);
      const el = document.getElementById(id);
      if (!el) return;
      el.type = "text";
      passwordTimers[id] = setTimeout(() => {
        if (!icon.classList.contains("crossed-eye")) {
          el.type = "password";
        }
        clearTimeout(passwordTimers[id]);
      }, 2000);
    }

    function hidePassword(id, icon) {
      clearTimeout(passwordTimers[id]);
      const el = document.getElementById(id);
      if (!el) return;
      if (!icon.classList.contains("crossed-eye")) {
        el.type = "password";
      }
    }

    function togglePassword(id, icon) {
      const el = document.getElementById(id);
      if (!el) return;
      if (icon.classList.contains("crossed-eye")) {
        icon.classList.remove("crossed-eye");
        el.type = "password";
      } else {
        icon.classList.add("crossed-eye");
        el.type = "text";
      }
    }

    function findUserIndexByEmailInput(emailInput, users) {
      if (!users) users = JSON.parse(localStorage.getItem("users") || "[]");
      let idx = users.findIndex(u => (u.email && u.email === emailInput));
      if (idx !== -1) return idx;
      if (!emailInput.includes('@')) {
        idx = users.findIndex(u => (u.email && u.email === (emailInput + "@gmail.com")));
        if (idx !== -1) return idx;
      }
      if (emailInput.toLowerCase().endsWith("@gmail.com")) {
        const short = emailInput.replace(/@gmail\.com$/i, "");
        idx = users.findIndex(u => (u.email && u.email === short));
        if (idx !== -1) return idx;
      }
      idx = users.findIndex(u => (u.email && u.email.toLowerCase() === emailInput.toLowerCase()));
      if (idx !== -1) return idx;
      return -1;
    }

    function normalizeUserRecord(email) {
      let users = JSON.parse(localStorage.getItem("users") || "[]");
      let idx = users.findIndex(u => u.email === email);
      if (idx === -1) {
        idx = findUserIndexByEmailInput(email, users);
      }
      if (idx === -1) return;
      const u = users[idx];
      const storedPassword = u.pass || u.password || u.pwd || u.pw || undefined;
      if (storedPassword) {
        users[idx].pass = storedPassword;
        users[idx].password = storedPassword;
      }
      if (!users[idx].avatar) users[idx].avatar = DEFAULT_AVATAR;
      localStorage.setItem("users", JSON.stringify(users));
    }

    function submitSignup() {
      let name = (document.getElementById("nameField")?.value || "").trim();
      let email = (document.getElementById("emailField")?.value || "").trim();
      let pass = (document.getElementById("passwordField")?.value || "").trim();
      let confirm = (document.getElementById("confirmPasswordField")?.value || "").trim();
      const msgDiv = document.getElementById("signupMessage");

      if (!name || !email || !pass || !confirm) {
        if (msgDiv) {
          msgDiv.innerText = "Please fill all fields";
          msgDiv.style.color = "red";
        }
        return;
      }
      if (pass.length < 6) {
        if (msgDiv) {
          msgDiv.innerText = "Password must be at least 6 characters";
          msgDiv.style.color = "red";
        }
        return;
      }
      if (pass !== confirm) {
        if (msgDiv) {
          msgDiv.innerText = "Passwords do not match";
          msgDiv.style.color = "red";
        }
        return;
      }

      let users = JSON.parse(localStorage.getItem("users") || "[]");
      let alreadyIdx = findUserIndexByEmailInput(email, users);
      if (alreadyIdx !== -1) {
        if (msgDiv) {
          msgDiv.innerText = "Email already exists. Please login.";
          msgDiv.style.color = "red";
        }
        return;
      }

      const newUser = {
        name,
        email,
        pass,
        password: pass,
        avatar: DEFAULT_AVATAR,
        cart: []
      };
      users.push(newUser);
      localStorage.setItem("users", JSON.stringify(users));
      localStorage.setItem("loggedInUser", email);
      currentUser = email;

      if (msgDiv) {
        msgDiv.innerText = "Account created successfully!";
        msgDiv.style.color = "green";
      }

      setTimeout(() => {
        closeAccountPanel();
        renderAccountPage();
      }, 1000);
    }

    function clearLoginMessage() {
      const msgDiv = document.getElementById("loginMessage");
      if (msgDiv) {
        msgDiv.innerText = "";
        msgDiv.style.color = "";
      }
    }

    function clearSignupMessage() {
      const msgDiv = document.getElementById("signupMessage");
      if (msgDiv) {
        msgDiv.innerText = "";
        msgDiv.style.color = "";
      }
    }

    function submitLogin() {
      let email = (document.getElementById("loginEmailField")?.value || "").trim();
      let pass = (document.getElementById("loginPasswordField")?.value || "").trim();
      const msgDiv = document.getElementById("loginMessage");

      if (!email || !pass) {
        if (msgDiv) {
          msgDiv.innerText = "Please fill all fields";
          msgDiv.style.color = "red";
        }
        return;
      }

      let users = JSON.parse(localStorage.getItem("users") || "[]");
      let idx = findUserIndexByEmailInput(email, users);
      if (idx === -1) {
        if (msgDiv) {
          msgDiv.innerText = "Account not found. Please sign up.";
          msgDiv.style.color = "red";
        }
        return;
      }

      const existing = users[idx];
      const storedPass = existing.pass ?? existing.password ?? existing.pwd ?? existing.pw ?? undefined;

      if (!storedPass) {
        if (msgDiv) {
          msgDiv.innerText = "No password stored for this account. Please sign up again.";
          msgDiv.style.color = "red";
        }
        return;
      }

      if (storedPass !== pass) {
        if (msgDiv) {
          msgDiv.innerText = "Incorrect password!";
          msgDiv.style.color = "red";
        }
        return;
      }

      users[idx].pass = storedPass;
      users[idx].password = storedPass;
      if (!users[idx].avatar) users[idx].avatar = DEFAULT_AVATAR;
      localStorage.setItem("users", JSON.stringify(users));

      localStorage.setItem("loggedInUser", existing.email || email);
      currentUser = existing.email || email;

      if (msgDiv) {
        msgDiv.innerText = "Login successful!";
        msgDiv.style.color = "green";
      }

      setTimeout(() => {
        closeAccountPanel();
        renderAccountPage();
      }, 1000);
    }

    function logout() {
      localStorage.removeItem("loggedInUser");
      currentUser = null;
      renderAccountPage();
    }

    renderAccountPage();
  </script>
</body>
</html>
