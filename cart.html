<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Food Express - Cart</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .toast-hidden { opacity: 0; transform: translateY(24px); }
    .toast-show { opacity: 1; transform: translateY(0); transition: all 400ms ease; }
    .animate-bump { transform: scale(1.08); transition: transform 0.18s; }
    .quantity-box { min-width: 30px; text-align: center; font-weight: bold; }
  </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800">

<header class="bg-white shadow-sm sticky top-0 z-40">
  <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
    <div class="text-xl font-bold text-orange-500">Food Express</div>
    <div class="cursor-pointer" id="homeBtn">Home</div>
  </div>
</header>

<main class="max-w-5xl mx-auto px-4 py-6">
  <h1 class="text-2xl font-bold mb-4">Your Cart</h1>

  <div id="cartContainer" class="space-y-4">
    <!-- Cart items injected here -->
  </div>

  <div class="mt-6 bg-white p-4 rounded-xl shadow flex justify-between items-center">
    <div class="text-lg font-semibold">Total:</div>
    <div class="text-xl font-bold text-orange-600" id="cartTotal">₹0</div>
  </div>

  <button id="checkoutBtn" class="mt-4 w-full bg-orange-500 text-white py-3 rounded-full font-bold shadow">Proceed to Checkout</button>
</main>

<!-- Toast -->
<div id="toast" class="fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-orange-500 text-white px-5 py-3 rounded-full shadow-lg toast-hidden z-50">Updated ✅</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCAGirQsFfQNInhUc9yuMD-QElaDnmRbKE",
  authDomain: "foodexpress-9b0ff.firebaseapp.com",
  projectId: "foodexpress-9b0ff",
  storageBucket: "foodexpress-9b0ff.firebasestorage.app",
  messagingSenderId: "818281594225",
  appId: "1:818281594225:web:205774c2914ae2b9b08ad0"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
window.__fe = { auth, db, doc, setDoc };

const LOCAL_CART_KEY = "fe_cart_v1";
let cart = JSON.parse(localStorage.getItem(LOCAL_CART_KEY) || "[]");

const toast = document.getElementById("toast");
function showToast(msg){
  toast.innerText = msg;
  toast.classList.remove("toast-hidden");
  toast.classList.add("toast-show");
  setTimeout(()=>{ toast.classList.remove("toast-show"); toast.classList.add("toast-hidden"); },1500);
}

function persistCart(){ 
  localStorage.setItem(LOCAL_CART_KEY, JSON.stringify(cart)); 
  updateCartUI(); 
  saveUserCart();
}

async function saveUserCart(){
  try{
    const user = auth.currentUser;
    if(!user) return;
    const userRef = doc(db,"users",user.uid);
    await setDoc(userRef,{cart},{merge:true});
  }catch(err){ console.error(err); }
}

function updateCartUI(){
  const container = document.getElementById("cartContainer");
  container.innerHTML = "";
  let total = 0;

  if(cart.length===0){
    container.innerHTML = '<p class="text-gray-500">Your cart is empty.</p>';
    document.getElementById("cartTotal").innerText = "₹0";
    return;
  }

  cart.forEach((item,index)=>{
    const itemTotal = item.price * (item.quantity||1);
    total += itemTotal;

    const div = document.createElement("div");
    div.className = "bg-white rounded-xl p-3 flex items-center gap-4 shadow";
    div.innerHTML = `
      <img src="${item.image}" class="w-20 h-20 object-cover rounded-lg"/>
      <div class="flex-1">
        <div class="font-semibold">${item.name}</div>
        <div class="text-gray-500">₹${item.price} × <span class="quantity-box" id="qty-${index}">${item.quantity}</span> = ₹<span id="item-total-${index}">${itemTotal}</span></div>
        <div class="mt-2 flex gap-2">
          <button class="decrease bg-gray-100 px-3 rounded-full">-</button>
          <button class="increase bg-gray-100 px-3 rounded-full">+</button>
          <button class="remove bg-red-500 text-white px-3 rounded-full">Remove</button>
        </div>
      </div>
    `;
    container.appendChild(div);

    // Add event listeners dynamically
    div.querySelector(".decrease").addEventListener("click",()=>changeQuantity(index,-1));
    div.querySelector(".increase").addEventListener("click",()=>changeQuantity(index,1));
    div.querySelector(".remove").addEventListener("click",()=>removeItem(index));
  });

  const cartTotalEl = document.getElementById("cartTotal");
  cartTotalEl.innerText = "₹" + total;
  cartTotalEl.classList.remove("animate-bump");
  void cartTotalEl.offsetWidth;
  cartTotalEl.classList.add("animate-bump");
}

function changeQuantity(index, delta){
  cart[index].quantity = (cart[index].quantity || 1) + delta;
  if(cart[index].quantity <= 0) cart.splice(index,1);
  persistCart();
  showToast("Cart updated ✅");
  animateItem(index);
}

function animateItem(index){
  const itemTotalEl = document.getElementById(`item-total-${index}`);
  const qtyEl = document.getElementById(`qty-${index}`);
  if(itemTotalEl && qtyEl){
    itemTotalEl.classList.remove("animate-bump");
    qtyEl.classList.remove("animate-bump");
    void itemTotalEl.offsetWidth;
    itemTotalEl.classList.add("animate-bump");
    qtyEl.classList.add("animate-bump");
  }
}

function removeItem(index){
  cart.splice(index,1);
  persistCart();
  showToast("Item removed ❌");
}

document.getElementById("checkoutBtn").addEventListener("click",()=>{
  if(cart.length===0){ showToast("Cart is empty"); return; }
  const total = cart.reduce((sum,item)=>sum + item.price*item.quantity,0);
  localStorage.setItem("fe_cart_total", total);
  window.location.href = "checkout.html";
});

document.getElementById("homeBtn").addEventListener("click",()=>window.location.href="index.html");

// Initialize UI
updateCartUI();

// Sync with Firestore if user logged in
onAuthStateChanged(auth, user => { if(user) saveUserCart(); });
</script>

</body>
</html>
