<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cart</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 pb-20">
  <div class="max-w-xl mx-auto p-4">
    <h1 class="text-2xl font-bold mb-4">ğŸ›’ Your Cart</h1>

    <!-- auth notice -->
    <div id="authNotice" class="hidden bg-yellow-50 border border-yellow-200 text-yellow-800 p-3 rounded mb-4">
      Please <a href="index.html" class="underline font-medium">log in</a> to view your cart.
    </div>

    <ul id="cartList" class="space-y-4"></ul>
    <p class="text-right mt-4 font-semibold text-lg">Total: â‚¹<span id="cartTotal">0.00</span></p>

    <button id="checkoutBtn" class="block w-full mt-6 bg-orange-500 hover:bg-orange-600 text-white font-semibold text-center py-2 rounded">
      Proceed to Checkout â†’
    </button>
  </div>

  <!-- Bottom Navigation -->
  <div class="fixed bottom-0 left-0 right-0 bg-white shadow-t p-2 flex justify-around items-center border-t">
    <a href="index.html" class="text-center">ğŸ <br><span class="text-xs">Home</span></a>
    <a href="orders.html" class="text-center">ğŸ“¦<br><span class="text-xs">Orders</span></a>
    <a href="cart.html" class="text-center text-orange-500">ğŸ›’<br><span class="text-xs">Cart</span></a>
    <a href="account.html" class="text-center">ğŸ‘¤<br><span class="text-xs">Account</span></a>
  </div>

  <!-- Firebase SDK + app logic -->
  <script type="module">
    // --- Firebase SDKs (v11) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { 
      getAuth, onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { 
      getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, serverTimestamp, collection, addDoc 
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // TODO: paste your config here
    const firebaseConfig = {
   apiKey: "AIzaSyCAGirQsFfQNInhUc9yuMD-QElaDnmRbKE",
   authDomain: "foodexpress-9b0ff.firebaseapp.com",
   projectId: "foodexpress-9b0ff",
   storageBucket: "foodexpress-9b0ff.firebasestorage.app",
   messagingSenderId: "818281594225",
   appId: "1:818281594225:web:205774c2914ae2b9b08ad0"
    };

    // init
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM
    const cartList = document.getElementById("cartList");
    const totalSpan = document.getElementById("cartTotal");
    const checkoutBtn = document.getElementById("checkoutBtn");
    const authNotice = document.getElementById("authNotice");

    // state
    let uid = null;
    let cart = []; // [{name, price, quantity, image?}]

    // helpers
    function renderCart() {
      cartList.innerHTML = "";
      if (!cart.length) {
        cartList.innerHTML = '<p class="text-gray-500 text-center">Your cart is empty ğŸ›ï¸</p>';
        totalSpan.textContent = "0.00";
        return;
      }
      cart.forEach((item, index) => {
        const li = document.createElement("li");
        li.className = "flex items-center bg-white rounded-lg shadow p-3";
        li.innerHTML = `
          <img src="${item.image || 'https://via.placeholder.com/60'}" alt="${item.name}" class="w-16 h-16 rounded object-cover mr-4">
          <div class="flex-1">
            <h3 class="font-semibold">${item.name}</h3>
            <p class="text-sm text-gray-500">â‚¹${Number(item.price).toFixed(2)} each</p>
            <div class="flex items-center mt-2 space-x-2">
              <button data-action="dec" data-index="${index}" class="bg-gray-200 px-2 rounded text-lg">âˆ’</button>
              <span>${item.quantity}</span>
              <button data-action="inc" data-index="${index}" class="bg-gray-200 px-2 rounded text-lg">+</button>
            </div>
          </div>
          <div class="flex flex-col items-end justify-between h-full ml-4">
            <div class="text-right font-bold">â‚¹${(Number(item.price) * Number(item.quantity)).toFixed(2)}</div>
            <button data-action="remove" data-index="${index}" class="text-red-500 text-sm mt-4 hover:underline">ğŸ—‘ Remove</button>
          </div>
        `;
        cartList.appendChild(li);
      });
      updateTotals();
    }

    function updateTotals() {
      const total = cart.reduce((sum, it) => sum + Number(it.price) * Number(it.quantity || 1), 0);
      totalSpan.textContent = total.toFixed(2);
    }

    async function saveCart() {
      if (!uid) return;
      const ref = doc(db, "users", uid);
      await setDoc(ref, { cart }, { merge: true });
    }

    function ensureQuantities() {
      cart = cart.map(i => ({ ...i, quantity: i.quantity ? Number(i.quantity) : 1 }));
    }

    // list click handlers (event delegation)
    cartList.addEventListener("click", async (e) => {
      const btn = e.target.closest("button");
      if (!btn) return;
      const idx = Number(btn.dataset.index);
      const action = btn.dataset.action;
      if (Number.isNaN(idx)) return;

      if (action === "inc") cart[idx].quantity += 1;
      if (action === "dec") {
        cart[idx].quantity = Math.max(0, cart[idx].quantity - 1);
        if (cart[idx].quantity === 0) cart.splice(idx, 1);
      }
      if (action === "remove") cart.splice(idx, 1);

      renderCart();
      await saveCart();
    });

    // checkout â†’ create order, clear cart
    checkoutBtn.addEventListener("click", async () => {
      if (!uid) { alert("Please log in first."); return; }
      if (!cart.length) { alert("ğŸ›ï¸ Your cart is empty!"); return; }

      const total = cart.reduce((sum, it) => sum + Number(it.price) * Number(it.quantity || 1), 0);

      try {
        await addDoc(collection(db, "orders"), {
          userId: uid,
          items: cart,
          total,
          status: "pending",
          createdAt: serverTimestamp()
        });

        // clear cart in Firestore and UI
        cart = [];
        await saveCart();
        renderCart();

        // go to confirmation page
        window.location.href = "order-confirmation.html";
      } catch (err) {
        alert("âŒ Failed to place order: " + err.message);
      }
    });

    // auth + live cart sync
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        uid = null;
        cart = [];
        renderCart();
        authNotice.classList.remove("hidden");

        // (optional) show local cart to encourage login
        return;
      }

      authNotice.classList.add("hidden");
      uid = user.uid;

      const ref = doc(db, "users", uid);

      // optional first-time merge: if local cart exists, merge once
      const local = JSON.parse(localStorage.getItem("cart") || "[]");
      if (local.length) {
        ensureQuantities();
        const snap = await getDoc(ref);
        const remote = snap.exists() && Array.isArray(snap.data().cart) ? snap.data().cart : [];
        const merged = [...remote];

        // merge by name+price (simple heuristic)
        local.forEach(li => {
          const key = (it) => `${it.name}|${it.price}|${it.image||""}`;
          const i = merged.findIndex(it => key(it) === key(li));
          if (i >= 0) merged[i].quantity = Number(merged[i].quantity || 1) + Number(li.quantity || 1);
          else merged.push({ ...li, quantity: Number(li.quantity || 1) });
        });

        cart = merged;
        await setDoc(ref, { cart }, { merge: true });
        localStorage.removeItem("cart");
      }

      // live subscribe to Firestore cart
      onSnapshot(ref, (snap) => {
        const data = snap.data() || {};
        cart = Array.isArray(data.cart) ? data.cart : [];
        ensureQuantities();
        renderCart();
      }, (err) => {
        console.error("Cart subscribe error:", err);
      });
    });

    // initial render (empty)
    renderCart();
  </script>
</body>
</html>
